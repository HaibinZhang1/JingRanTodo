# 自动化测试框架详细设计

## 1. 概述

本文档描述 ZenHubBoard 项目自动化测试框架的详细设计，包括三层测试架构、配置说明、测试用例编写规范及最佳实践。

---

## 2. 架构设计

### 2.1 三层测试架构

```
┌─────────────────────────────────────────────────────────────┐
│                      E2E 测试 (Playwright)                   │
│          测试完整用户流程、Electron 窗口行为                   │
├─────────────────────────────────────────────────────────────┤
│                   集成测试 (Vitest)                          │
│          测试组件与 Store 交互、多组件协作                     │
├─────────────────────────────────────────────────────────────┤
│                  单元测试 (Jest + RTL)                       │
│          测试 Redux Slices、工具函数、纯组件                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
ZenHubBoard/
├── src/
│   └── __tests__/                    # 测试目录
│       ├── setupTests.ts             # Jest 环境配置
│       ├── setupTests.vitest.ts      # Vitest 环境配置
│       ├── utils/                    # 工具函数单元测试
│       │   └── taskUtils.test.ts
│       ├── store/                    # Redux Slice 单元测试
│       │   └── tasksSlice.test.ts
│       └── integration/              # 集成测试
│           └── TaskPanel.integration.test.ts
├── e2e/                              # E2E 测试目录
│   └── app.e2e.ts
├── jest.config.js                    # Jest 配置
├── vitest.config.ts                  # Vitest 配置
└── playwright.config.ts              # Playwright 配置
```

---

## 3. 配置说明

### 3.1 Jest 配置 (单元测试)

**文件**: `jest.config.js`

| 配置项 | 值 | 说明 |
|--------|-----|------|
| preset | ts-jest | 支持 TypeScript |
| testEnvironment | jsdom | 模拟浏览器环境 |
| testMatch | `**/__tests__/**/*.test.ts?(x)` | 匹配测试文件 |
| setupFilesAfterEnv | `setupTests.ts` | 测试前执行的配置 |

### 3.2 Vitest 配置 (集成测试)

**文件**: `vitest.config.ts`

| 配置项 | 值 | 说明 |
|--------|-----|------|
| environment | jsdom | 模拟浏览器环境 |
| include | `integration/**/*.test.{ts,tsx}` | 仅包含集成测试 |
| setupFiles | `setupTests.vitest.ts` | Vitest 专用配置 |

### 3.3 Playwright 配置 (E2E 测试)

**文件**: `playwright.config.ts`

| 配置项 | 值 | 说明 |
|--------|-----|------|
| testDir | `./e2e` | E2E 测试目录 |
| timeout | 30000 | 超时时间 30 秒 |
| retries | 1 | 失败重试 1 次 |

---

## 4. 测试用例编写规范

### 4.1 单元测试编写

**位置**: `src/__tests__/utils/` 或 `src/__tests__/store/`

**命名规范**: `[被测模块名].test.ts`

**模板**:

```typescript
// 文件: src/__tests__/utils/myUtils.test.ts
import { myFunction } from '../../renderer/utils/myUtils'

describe('myFunction', () => {
  it('should return expected result when given valid input', () => {
    const result = myFunction('input')
    expect(result).toBe('expected')
  })

  it('should handle edge case', () => {
    expect(myFunction('')).toBe('')
  })

  it('should throw error for invalid input', () => {
    expect(() => myFunction(null)).toThrow()
  })
})
```

### 4.2 Redux Slice 测试编写

**位置**: `src/__tests__/store/`

**命名规范**: `[sliceName]Slice.test.ts`

**模板**:

```typescript
// 文件: src/__tests__/store/mySlice.test.ts
import { configureStore } from '@reduxjs/toolkit'
import myReducer, { myAction, myAsyncThunk } from '../../renderer/store/mySlice'

// 辅助函数：创建测试 Store
const createTestStore = () => configureStore({
  reducer: { my: myReducer },
})

describe('mySlice', () => {
  describe('reducers', () => {
    it('myAction should update state correctly', () => {
      const store = createTestStore()
      store.dispatch(myAction({ payload: 'value' }))
      expect(store.getState().my.field).toBe('value')
    })
  })

  describe('async thunks', () => {
    it('myAsyncThunk should update state on success', async () => {
      const store = createTestStore()
      await store.dispatch(myAsyncThunk({ data: 'test' }))
      expect(store.getState().my.items.length).toBeGreaterThan(0)
    })
  })
})
```

### 4.3 集成测试编写

**位置**: `src/__tests__/integration/`

**命名规范**: `[组件/功能名].integration.test.ts`

**模板**:

```typescript
// 文件: src/__tests__/integration/MyFeature.integration.test.ts
import { describe, it, expect, vi } from 'vitest'
import { configureStore } from '@reduxjs/toolkit'
import myReducer from '../../renderer/store/mySlice'

const createTestStore = (preloadedState = {}) => {
  return configureStore({
    reducer: { my: myReducer },
    preloadedState,
  })
}

describe('MyFeature Integration Tests', () => {
  it('should filter items correctly', () => {
    const store = createTestStore({
      my: {
        items: [
          { id: '1', category: 'A' },
          { id: '2', category: 'B' },
        ],
      },
    })

    const filtered = store.getState().my.items.filter(i => i.category === 'A')
    expect(filtered.length).toBe(1)
  })
})
```

### 4.4 E2E 测试编写

**位置**: `e2e/`

**命名规范**: `[功能名].e2e.ts`

**模板**:

```typescript
// 文件: e2e/myFeature.e2e.ts
import { test, expect, _electron as electron } from '@playwright/test'
import path from 'path'

let electronApp: any
let window: any

test.beforeAll(async () => {
  electronApp = await electron.launch({
    args: [path.join(__dirname, '../dist-electron/main/index.js')],
  })
  window = await electronApp.firstWindow()
})

test.afterAll(async () => {
  await electronApp.close()
})

test.describe('My Feature E2E', () => {
  test('should perform user action correctly', async () => {
    // 1. 找到元素
    await window.click('[data-testid="my-button"]')
    
    // 2. 验证结果
    const result = await window.locator('[data-testid="result"]').textContent()
    expect(result).toContain('expected')
  })
})
```

---

## 5. 测试用例保存位置

| 测试类型 | 保存位置 | 文件命名 |
|---------|---------|---------|
| 工具函数单元测试 | `src/__tests__/utils/` | `[函数模块名].test.ts` |
| Redux Slice 测试 | `src/__tests__/store/` | `[sliceName]Slice.test.ts` |
| 组件单元测试 | `src/__tests__/components/` | `[ComponentName].test.tsx` |
| 集成测试 | `src/__tests__/integration/` | `[功能名].integration.test.ts` |
| E2E 测试 | `e2e/` | `[功能名].e2e.ts` |

---

## 6. 运行测试命令

| 命令 | 说明 | 使用场景 |
|------|------|---------|
| `npm test` | 运行所有单元测试 | 修改代码后验证 |
| `npm run test:watch` | 监听模式运行测试 | 开发过程中持续测试 |
| `npm run test:coverage` | 生成覆盖率报告 | 检查测试覆盖情况 |
| `npm run test:integration` | 运行集成测试 | 验证组件交互 |
| `npm run test:e2e` | 运行 E2E 测试 | 验证完整功能流程 |
| `npm run test:all` | 运行全部测试 | 发布前全面验证 |

---

## 7. Mock 配置说明

### 7.1 Jest Mock (setupTests.ts)

```typescript
// Mock electronAPI
Object.defineProperty(window, 'electronAPI', {
  value: {
    getAllTasks: jest.fn().mockResolvedValue([]),
    createTask: jest.fn().mockResolvedValue(undefined),
    // ... 其他 API
  },
  writable: true,
})
```

### 7.2 Vitest Mock (setupTests.vitest.ts)

```typescript
import { vi } from 'vitest'

Object.defineProperty(window, 'electronAPI', {
  value: {
    getAllTasks: vi.fn().mockResolvedValue([]),
    createTask: vi.fn().mockResolvedValue(undefined),
    // ... 其他 API
  },
  writable: true,
})
```

---

## 8. 最佳实践

1. **一个测试只验证一件事** - 每个 `it()` 块只测试一个行为
2. **使用有意义的描述** - `describe` 和 `it` 的描述应清晰表达测试意图
3. **遵循 AAA 模式** - Arrange (准备), Act (执行), Assert (断言)
4. **Mock 外部依赖** - electronAPI、网络请求等应该被 mock
5. **测试边界条件** - 空数组、null 值、边界值等
6. **保持测试独立** - 测试之间不应有依赖关系
7. **添加 data-testid** - 为需要 E2E 测试的元素添加 `data-testid` 属性

---

## 9. 添加新测试用例步骤
  })

  it('should throw error for invalid input', () => {
    expect(() => myFunction(null)).toThrow()
  })
})
```

### 4.2 Redux Slice 测试编写

**位置**: `src/__tests__/store/`

**命名规范**: `[sliceName]Slice.test.ts`

**模板**:

```typescript
// 文件: src/__tests__/store/mySlice.test.ts
import { configureStore } from '@reduxjs/toolkit'
import myReducer, { myAction, myAsyncThunk } from '../../renderer/store/mySlice'

// 辅助函数：创建测试 Store
const createTestStore = () => configureStore({
  reducer: { my: myReducer },
})

describe('mySlice', () => {
  describe('reducers', () => {
    it('myAction should update state correctly', () => {
      const store = createTestStore()
      store.dispatch(myAction({ payload: 'value' }))
      expect(store.getState().my.field).toBe('value')
    })
  })

  describe('async thunks', () => {
    it('myAsyncThunk should update state on success', async () => {
      const store = createTestStore()
      await store.dispatch(myAsyncThunk({ data: 'test' }))
      expect(store.getState().my.items.length).toBeGreaterThan(0)
    })
  })
})
```

### 4.3 集成测试编写

**位置**: `src/__tests__/integration/`

**命名规范**: `[组件/功能名].integration.test.ts`

**模板**:

```typescript
// 文件: src/__tests__/integration/MyFeature.integration.test.ts
import { describe, it, expect, vi } from 'vitest'
import { configureStore } from '@reduxjs/toolkit'
import myReducer from '../../renderer/store/mySlice'

const createTestStore = (preloadedState = {}) => {
  return configureStore({
    reducer: { my: myReducer },
    preloadedState,
  })
}

describe('MyFeature Integration Tests', () => {
  it('should filter items correctly', () => {
    const store = createTestStore({
      my: {
        items: [
          { id: '1', category: 'A' },
          { id: '2', category: 'B' },
        ],
      },
    })

    const filtered = store.getState().my.items.filter(i => i.category === 'A')
    expect(filtered.length).toBe(1)
  })
})
```

### 4.4 E2E 测试编写

**位置**: `e2e/`

**命名规范**: `[功能名].e2e.ts`

**模板**:

```typescript
// 文件: e2e/myFeature.e2e.ts
import { test, expect, _electron as electron } from '@playwright/test'
import path from 'path'

let electronApp: any
let window: any

test.beforeAll(async () => {
  electronApp = await electron.launch({
    args: [path.join(__dirname, '../dist-electron/main/index.js')],
  })
  window = await electronApp.firstWindow()
})

test.afterAll(async () => {
  await electronApp.close()
})

test.describe('My Feature E2E', () => {
  test('should perform user action correctly', async () => {
    // 1. 找到元素
    await window.click('[data-testid="my-button"]')
    
    // 2. 验证结果
    const result = await window.locator('[data-testid="result"]').textContent()
    expect(result).toContain('expected')
  })
})
```

---

## 5. 测试用例保存位置

| 测试类型 | 保存位置 | 文件命名 |
|---------|---------|---------|
| 工具函数单元测试 | `src/__tests__/utils/` | `[函数模块名].test.ts` |
| Redux Slice 测试 | `src/__tests__/store/` | `[sliceName]Slice.test.ts` |
| 组件单元测试 | `src/__tests__/components/` | `[ComponentName].test.tsx` |
| 集成测试 | `src/__tests__/integration/` | `[功能名].integration.test.ts` |
| E2E 测试 | `e2e/` | `[功能名].e2e.ts` |

---

## 6. 运行测试命令

| 命令 | 说明 | 使用场景 |
|------|------|---------|
| `npm test` | 运行所有单元测试 | 修改代码后验证 |
| `npm run test:watch` | 监听模式运行测试 | 开发过程中持续测试 |
| `npm run test:coverage` | 生成覆盖率报告 | 检查测试覆盖情况 |
| `npm run test:integration` | 运行集成测试 | 验证组件交互 |
| `npm run test:e2e` | 运行 E2E 测试 | 验证完整功能流程 |
| `npm run test:all` | 运行全部测试 | 发布前全面验证 |

---

## 7. Mock 配置说明

### 7.1 Jest Mock (setupTests.ts)

```typescript
// Mock electronAPI
Object.defineProperty(window, 'electronAPI', {
  value: {
    getAllTasks: jest.fn().mockResolvedValue([]),
    createTask: jest.fn().mockResolvedValue(undefined),
    // ... 其他 API
  },
  writable: true,
})
```

### 7.2 Vitest Mock (setupTests.vitest.ts)

```typescript
import { vi } from 'vitest'

Object.defineProperty(window, 'electronAPI', {
  value: {
    getAllTasks: vi.fn().mockResolvedValue([]),
    createTask: vi.fn().mockResolvedValue(undefined),
    // ... 其他 API
  },
  writable: true,
})
```

---

## 8. 最佳实践

1. **一个测试只验证一件事** - 每个 `it()` 块只测试一个行为
2. **使用有意义的描述** - `describe` 和 `it` 的描述应清晰表达测试意图
3. **遵循 AAA 模式** - Arrange (准备), Act (执行), Assert (断言)
4. **Mock 外部依赖** - electronAPI、网络请求等应该被 mock
5. **测试边界条件** - 空数组、null 值、边界值等
6. **保持测试独立** - 测试之间不应有依赖关系
7. **添加 data-testid** - 为需要 E2E 测试的元素添加 `data-testid` 属性

---

## 9. 添加新测试用例步骤

1. **确定测试类型** - 单元/集成/E2E
2. **创建测试文件** - 按命名规范在对应目录创建
3. **编写测试用例** - 参考上述模板
4. **运行测试验证** - `npm test` 或对应命令
5. **提交代码** - 测试文件与源码一起提交

## 10. 已添加的 data-testid 属性

以下组件已添加 `data-testid` 属性用于 E2E 测试：

### 侧边栏 (Sidebar.tsx)
| 元素 | data-testid | 说明 |
|------|-------------|------|
| 侧边栏容器 | `sidebar` | 整个侧边栏 |
| 任务导航 | `nav-board` | 任务面板按钮 |
| 日历导航 | `nav-calendar` | 日历面板按钮 |
| 笔记导航 | `nav-notes` | 笔记面板按钮 |
| 周期任务导航 | `nav-recurring` | 周期任务按钮 |
| 导入按钮 | `btn-import` | Excel 导入按钮 |
| 番茄钟按钮 | `btn-timer` | 番茄钟切换按钮 |
| 设置按钮 | `btn-settings` | 设置面板按钮 |

### 通用组件 (GlassPanel.tsx)
- 支持传入 `data-testid` 属性

---

## 11. E2E 测试运行结果

**首次运行结果**：6 个测试通过

通过的测试包括：
- ✅ 应用启动测试
- ✅ 窗口控制测试
- ✅ 应用版本信息验证

> [!NOTE]
> 部分导航测试因元素加载时间问题超时，可通过增加等待时间或优化选择器解决。
