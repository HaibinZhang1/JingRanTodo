# ZenHubBoard 项目报错与解决方案文档

本文档记录项目启动过程中遇到的所有问题及其解决方案。

---

## 目录

- [环境配置类问题](#环境配置类问题)
- [依赖安装类问题](#依赖安装类问题)
- [启动运行类问题](#启动运行类问题)
- [Electron 相关问题](#electron-相关问题)

---

## 环境配置类问题

### 问题 1：PowerShell 执行策略阻止 npm 运行

**错误信息：**
```
npm : 无法加载文件 D:\Program Files\node\npm.ps1，因为在此系统上禁止运行脚本。
CategoryInfo: SecurityError
FullyQualifiedErrorId: UnauthorizedAccess
```

**原因分析：**
Windows PowerShell 默认安全策略禁止运行未签名的脚本文件。

**解决方案：**
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**说明：** `RemoteSigned` 策略允许运行本地脚本，但要求远程下载的脚本必须有数字签名。

---

## 依赖安装类问题

### 问题 2：npm install 网络连接失败 (ECONNRESET)

**错误信息：**
```
npm error code ECONNRESET
npm error errno ECONNRESET
npm error network request to https://registry.npmjs.org/xxx failed, reason: Client network socket disconnected before secure TLS connection was established
```

**原因分析：**
网络连接不稳定，TLS 握手失败。可能原因：
1. 网络代理问题
2. DNS 解析问题
3. 防火墙/VPN 干扰
4. npm 官方源访问不稳定

**解决方案：**

**方案一：使用淘宝镜像源（推荐）**
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

**方案二：增加网络超时时间**
```bash
npm config set timeout 60000
npm install
```

**方案三：清理缓存后重试**
```bash
npm cache clean --force
npm install
```

**方案四：恢复官方源**
```bash
npm config set registry https://registry.npmjs.org
```

---

## 启动运行类问题

> 以下记录 npm run dev / electron:dev 过程中的问题

---

## Electron 相关问题

### 问题 3：node-gyp 编译失败 - 缺少 Python 环境

**错误信息：**
```
npm error gyp ERR! find Python
npm error gyp ERR! find Python **********************************************************
npm error gyp ERR! find Python You need to install the latest version of Python.
npm error gyp ERR! configure error
npm error gyp ERR! stack Error: Could not find any Python installation to use
```

**原因分析：**
项目中的 `electron-disable-minimize` 或 `koffi` 等依赖包含原生 C++ 模块，需要使用 node-gyp 编译。node-gyp 需要：
1. Python 3.6+
2. Visual Studio Build Tools（Windows）

**解决方案：**

**方案一：安装 windows-build-tools（推荐）**
以管理员身份运行 PowerShell：
```powershell
npm install --global windows-build-tools
```
此命令会自动安装 Python 和 Visual Studio Build Tools。

**方案二：手动安装 Python**
1. 从 https://www.python.org/downloads/ 下载 Python 3.x
2. 安装时勾选 "Add Python to PATH"
3. 配置 npm：
```bash
npm config set python "C:\Path\To\python.exe"
```

**方案三：安装 Visual Studio Build Tools**
1. 下载 [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)
2. 安装时选择 "C++ 生成工具" 工作负载

**方案四：跳过原生模块编译（临时方案）**
```bash
npm install --ignore-scripts
```
注意：此方案可能导致某些功能不可用。

---

### 问题 4：require('electron') 返回路径字符串而非模块对象

**错误信息：**
```javascript
const { app } = require('electron');
// TypeError: Cannot read properties of undefined (reading 'whenReady')
// 或
// TypeError: Cannot read properties of undefined (reading 'on')
```

**调试发现：**
```javascript
const electron = require('electron');
console.log(typeof electron);  // 输出: "string"
console.log(electron);  // 输出: "D:\\...\\node_modules\\electron\\dist\\electron.exe"
```

**原因分析：**
这是一个罕见的 Electron 内部模块加载问题。正常情况下，Electron 主进程会拦截 `require('electron')` 调用并返回内置 API 模块。但由于某种原因（可能与 Node.js 版本、Windows 系统版本、或 Electron 安装问题相关），这个拦截没有正确工作，导致 require 解析到了 `node_modules/electron/index.js`（该文件导出 electron.exe 的路径）。

**可能的原因：**
1. Node.js v24+ 与 Electron 的兼容性问题
2. Windows 系统版本或安全策略影响
3. Electron 二进制文件损坏或不完整
4. npm 缓存问题

**解决方案：**

**方案一：降级 Node.js 版本**
```bash
# 建议使用 Node.js v18 或 v20 LTS
# 可使用 nvm-windows 管理多版本
nvm install 18
nvm use 18
```

**方案二：完全清理并重装**
```bash
# 删除所有相关缓存和文件
Remove-Item -Recurse -Force node_modules
Remove-Item package-lock.json
npm cache clean --force

# 重新安装
npm install
```

**方案三：使用 yarn 替代 npm**
```bash
npm install -g yarn
yarn install
```

**方案四：检查并修复 Electron 环境变量**
确保没有设置影响 Electron 的环境变量：
```powershell
$env:ELECTRON_RUN_AS_NODE = $null
$env:ELECTRON_OVERRIDE_DIST_PATH = $null
```

---

## 更新记录

| 日期 | 问题描述 | 解决方案 |
|------|----------|----------|
| 2025-12-15 | PowerShell 执行策略阻止 npm | `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser` |
| 2025-12-15 | npm install 网络连接失败 (ECONNRESET) | 使用淘宝镜像源 `npm config set registry https://registry.npmmirror.com` |
| 2025-12-15 | node-gyp 编译失败缺少 Python | 使用 `npm install --ignore-scripts` 跳过编译 |
| 2025-12-15 | Electron require 返回字符串 | **根本原因: `ELECTRON_RUN_AS_NODE=1`**，使用 `$env:ELECTRON_RUN_AS_NODE = $null` 清除 |

