# ZenHubBoard 需求规划文档

## 文档信息
- **版本**: 1.1.0
- **更新日期**: 2025-12-28
- **产品名称**: ZenHubBoard
- **产品定位**: 离线桌面待办清单管理软件

---

## 目录

1. [项目概述](#1-项目概述)
   - 1.1 [产品愿景](#11-产品愿景)
   - 1.2 [目标用户](#12-目标用户)
   - 1.3 [核心价值](#13-核心价值)

2. [项目目录结构](#2-项目目录结构)
   - 2.1 [根目录结构](#21-根目录结构)
   - 2.2 [源码目录结构](#22-源码目录结构)
   - 2.3 [Main 进程模块](#23-main-进程模块)
   - 2.4 [Renderer 渲染层模块](#24-renderer-渲染层模块)

3. [功能需求](#3-功能需求)
   - 3.1 [任务管理](#31-任务管理)
   - 3.2 [日历视图](#32-日历视图)
   - 3.3 [周期任务](#33-周期任务)
   - 3.4 [智能闪念胶囊](#34-智能闪念胶囊)
   - 3.5 [笔记系统](#35-笔记系统)
   - 3.6 [桌面挂件](#36-桌面挂件)
   - 3.7 [系统设置](#37-系统设置)
   - 3.8 [数据管理](#38-数据管理)

4. [业务规则](#4-业务规则)
   - 4.1 [任务过滤规则](#41-任务过滤规则)
   - 4.2 [任务排序规则](#42-任务排序规则)
   - 4.3 [任务拖放规则](#43-任务拖放规则)
   - 4.4 [周期任务调度规则](#44-周期任务调度规则)
   - 4.5 [持续任务生成规则](#45-持续任务生成规则)
   - 4.6 [提醒系统规则](#46-提醒系统规则)
   - 4.7 [日历视图规则](#47-日历视图规则)
   - 4.8 [面板管理规则](#48-面板管理规则)

5. [非功能需求](#5-非功能需求)
   - 5.1 [性能需求](#51-性能需求)
   - 5.2 [安全需求](#52-安全需求)
   - 5.3 [兼容性需求](#53-兼容性需求)

6. [术语表](#6-术语表)

---

## 1. 项目概述

### 1.1 产品愿景

ZenHubBoard 是一款专注于离线使用的桌面待办清单管理软件，旨在为用户提供轻量、沉浸、无干扰的任务管理体验。采用 Glassmorphism（深度毛玻璃拟态）设计风格，利用透明度、模糊和光影构建视觉层级。

### 1.2 目标用户

- 需要高效管理日常任务的个人用户
- 偏好离线工作环境的专业人士
- 追求美观且功能完备的任务管理工具的用户

### 1.3 核心价值

- **离线优先**: 完全本地化数据存储，无需联网
- **智能解析**: AI 驱动的自然语言任务输入
- **沉浸体验**: 毛玻璃拟态设计，减少视觉干扰
- **灵活定制**: 支持自定义面板、主题和快捷键

---

## 2. 项目目录结构

### 2.1 根目录结构

```
ZenHubBoard/
├── .git/                          # Git 版本控制
├── data/                          # 数据存储目录
├── dist/                          # 前端构建输出
├── dist-electron/                 # Electron 主进程构建输出
├── node_modules/                  # 依赖包
├── public/                        # 静态资源
│   ├── holiday/                   # 节假日数据 (2个文件)
│   ├── images/                    # 图片资源
│   ├── notes/                     # 笔记模板 (5个文件)
│   ├── task/                      # 任务模板 (1个文件)
│   ├── icon.ico                   # 应用图标
│   ├── icon.png                   # 应用图标（PNG）
│   └── icon.svg                   # 应用图标（SVG）
├── release/                       # 应用发布包
├── scripts/                       # 构建脚本
├── shili/                         # 示例文件
├── src/                           # 源代码目录
├── index.html                     # 入口 HTML
├── package.json                   # 项目配置
├── postcss.config.js              # PostCSS 配置
├── tailwind.config.js             # Tailwind CSS 配置
├── tsconfig.json                  # TypeScript 配置
├── tsconfig.node.json             # Node.js TypeScript 配置
└── vite.config.ts                 # Vite 构建配置
```

### 2.2 源码目录结构

```
src/
├── main/                          # Electron 主进程 (21个子项)
│   ├── capsule/                   # AI 闪念胶囊服务 (3个文件)
│   ├── excel/                     # Excel 导入模块 (2个文件)
│   ├── utils/                     # 工具函数 (1个文件)
│   └── [15个核心模块文件]
├── preload/                       # 预加载脚本 (1个文件)
└── renderer/                      # 渲染进程 (47个子项)
    ├── components/                # UI 组件 (25个文件)
    ├── hooks/                     # 自定义 Hooks (1个文件)
    ├── i18n/                      # 国际化 (3个文件)
    ├── services/                  # 服务层 (1个文件)
    ├── store/                     # Redux 状态管理 (6个文件)
    ├── styles/                    # 样式文件 (1个文件)
    ├── utils/                     # 工具函数
    └── views/                     # 视图组件 (7个文件)
```

### 2.3 Main 进程模块

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `index.ts` | 30.2KB | 应用入口，IPC 处理器，生命周期管理 |
| `database.ts` | 49.2KB | SQLite 数据库操作，包含 51 个核心函数 |
| `cardWindow.ts` | 23.0KB | 任务卡片浮动窗口管理 |
| `desktopAttach.ts` | 17.9KB | 桌面嵌入功能（Windows 桌面附着） |
| `noteWindow.ts` | 9.1KB | 笔记浮动窗口管理 |
| `notes.ts` | 8.7KB | 笔记 CRUD 操作 |
| `updater.ts` | 7.1KB | 应用自动更新 |
| `reminder.ts` | 5.6KB | 任务提醒系统 |
| `capsuleWindow.ts` | 4.4KB | 闪念胶囊窗口管理 |
| `weekViewWindow.ts` | 3.9KB | 周视图浮动窗口 |
| `recurrence.ts` | 3.8KB | 周期任务调度 |
| `shortcuts.ts` | 2.6KB | 全局快捷键注册 |
| `backup.ts` | 2.4KB | 数据备份还原 |
| `tray.ts` | 2.3KB | 系统托盘管理 |
| `sql.js.d.ts` | 1.0KB | SQL.js 类型定义 |

#### capsule/ 子目录（AI 闪念胶囊）

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `localParser.ts` | 11.3KB | 本地自然语言解析器 |
| `aiService.ts` | 8.4KB | AI 服务（Gemini/OpenAI 兼容） |
| `parseService.ts` | 8.0KB | 解析服务统一入口 |

#### excel/ 子目录

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `excelParser.ts` | 10.8KB | Excel 文件解析 |
| `importHandler.ts` | 7.0KB | IPC 导入处理器 |

### 2.4 Renderer 渲染层模块

#### components/ - UI 组件 (25个)

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `TaskDetailModal.tsx` | 70.6KB | 任务详情编辑弹窗 |
| `DesktopWidget.tsx` | 33.9KB | 桌面挂件组件 |
| `WeekViewSection.tsx` | 32.1KB | 周视图区块 |
| `ExcelImportModal.tsx` | 24.9KB | Excel 导入弹窗 |
| `AIExtensionCenter.tsx` | 23.4KB | AI 扩展中心 |
| `CustomPanelGrid.tsx` | 23.1KB | 自定义面板网格 |
| `TaskCard.tsx` | 17.8KB | 任务卡片组件 |
| `MarkdownToolbar.tsx` | 10.3KB | Markdown 工具栏 |
| `AvatarUploadModal.tsx` | 9.8KB | 头像上传弹窗 |
| `SmartChip.tsx` | 9.5KB | 智能标签组件 |
| `TaskPreviewCard.tsx` | 8.7KB | 任务预览卡片 |
| `MarkdownRenderer.tsx` | 6.5KB | Markdown 渲染器 |
| `CalendarContextMenu.tsx` | 6.3KB | 日历右键菜单 |
| `WeekViewWidget.tsx` | 6.0KB | 周视图挂件 |
| `ShortcutRecorder.tsx` | 5.4KB | 快捷键录制器 |
| `ConfirmModal.tsx` | 5.3KB | 确认对话框 |
| `PanelInputBar.tsx` | 4.4KB | 面板输入栏 |
| `TaskPanel.tsx` | 4.2KB | 任务面板 |
| `Sidebar.tsx` | 4.9KB | 侧边栏导航 |
| `PomodoroTimer.tsx` | 3.3KB | 番茄钟计时器 |
| `InputModal.tsx` | 3.3KB | 输入弹窗 |
| `GlassPanel.tsx` | 2.8KB | 毛玻璃面板 |
| `SectionHeader.tsx` | 2.6KB | 区块标题 |
| `ErrorBoundary.tsx` | 2.0KB | 错误边界 |
| `index.ts` | 0.9KB | 组件导出 |

#### views/ - 视图页面 (7个)

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `SettingsView.tsx` | 54.0KB | 设置页面 |
| `CalendarView.tsx` | 49.7KB | 日历视图（周/月视图、甘特图） |
| `TaskDashboard.tsx` | 37.7KB | 任务仪表盘（主页） |
| `RecurringTaskView.tsx` | 30.1KB | 周期任务管理 |
| `NotesView.tsx` | 26.1KB | 笔记列表视图 |
| `CapsuleView.tsx` | 13.7KB | 闪念胶囊视图 |
| `NoteFloatingView.tsx` | 11.1KB | 笔记浮动窗口视图 |

#### store/ - Redux 状态管理 (6个)

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| `settingsSlice.ts` | 10.8KB | 设置状态管理 |
| `tasksSlice.ts` | 10.5KB | 任务状态管理（核心） |
| `notesSlice.ts` | 5.5KB | 笔记状态管理 |
| `recurringSlice.ts` | 4.2KB | 周期任务状态 |
| `pomodoroSlice.ts` | 4.1KB | 番茄钟状态 |
| `index.ts` | 0.8KB | Store 配置 |

---

## 3. 功能需求

### 3.1 任务管理

#### 3.1.1 任务基本属性

| 属性 | 类型 | 说明 |
|------|------|------|
| 标题 | 文本 | 必填，任务名称 |
| 描述 | 文本 | 选填，任务详情 |
| 状态 | 枚举 | `todo` / `done` |
| 优先级 | 枚举 | 五级：very-low / low / medium / high / very-high |
| 置顶 | 布尔 | 是否在面板内置顶显示 |
| 开始日期 | 日期时间 | 任务开始时间 |
| 截止日期 | 日期时间 | 任务截止时间 |
| 完成时间 | 日期时间 | 标记完成的时间 |
| 所属面板 | ID | 关联的自定义面板 |
| 排序权重 | 字符串 | rank 排序值 |

#### 3.1.2 任务创建

**功能入口**：
- 面板快速输入栏
- 详情弹窗（支持完整属性设置）
- 日历右键菜单
- 闪念胶囊

**详情弹窗字段**：
- 任务标题（必填）
- 任务描述（选填，文本域）
- 开始日期时间（日期 + 时:分选择器）
- 截止日期时间（日期 + 时:分选择器）
- 优先级（圆形色块选择）
- 提醒设置（开关 + 日期时间）
- 持续任务选项（当 start_date ≠ due_date 时显示）
- 子任务管理

**快捷键**：
- `ESC`: 取消/关闭弹窗
- `Ctrl/Cmd + Enter`: 保存

#### 3.1.3 任务编辑

**编辑功能**：
- 标题内联编辑（双击任务卡片标题）
- 详情弹窗编辑（点击编辑按钮）
- 状态切换（点击复选框）
- 置顶切换（点击置顶按钮）

**逾期标识**：
- 当任务 `status = 'todo'` 且 `due_date < 今日` 时显示"已逾期"标签

#### 3.1.4 任务删除

**删除流程**：
1. 点击删除按钮
2. 弹出确认对话框
3. 确认后删除任务及其所有子任务

#### 3.1.5 子任务管理

**子任务属性**：

| 属性 | 类型 | 说明 |
|------|------|------|
| 标题 | 文本 | 必填 |
| 描述 | 文本 | 选填 |
| 优先级 | 枚举 | 五级优先级 |
| 完成状态 | 布尔 | 是否完成 |
| 提醒设置 | 对象 | 日期/时/分 |
| 排序值 | 数字 | order 值 |

**子任务操作**：
- 在任务详情弹窗中添加
- 可展开查看/编辑描述和优先级
- 支持独立提醒设置
- 删除时无需确认

**主任务联动**：
- 主任务完成时，自动将所有子任务标记为完成
- 主任务完成后自动取消置顶

#### 3.1.6 任务面板

**今日待办面板**：
- 固定在左侧，宽度 360px
- 显示今日到期/逾期任务 + 今日完成任务
- 支持快速输入
- 支持开启浮动窗口
- 支持复制已完成任务

**自定义面板**：
- 最多创建 6 个
- 支持拖拽排序
- 支持重命名（双击标题）
- 支持删除（级联删除任务）
- 默认面板：工作、学习、生活

**面板操作按钮**（悬停显示）：
- 开启/关闭浮动窗口
- 删除面板（仅自定义面板）

#### 3.1.7 复制功能

**复制已完成任务**：
- 在面板底部显示（悬停时可见）
- 支持三种格式：
  - Text（自定义模板）
  - JSON（结构化数据）
  - Markdown（层级结构）

**模板变量**：
- `{{chinese_index}}`: 中文序号（一、二、三...）
- `{{index}}`: 数字序号
- `{{title}}`: 任务标题
- `{{description}}`: 任务描述
- `{{subtasks}}`: 子任务内容

**每面板独立设置**：
- 复制按钮右侧显示⚙️设置图标
- 点击打开复制格式设置弹窗
- 每个面板可独立配置复制格式和模板
- 自定义面板设置持久化到数据库

### 3.2 日历视图

#### 3.2.1 视图模式

| 模式 | 说明 |
|------|------|
| 周视图 | 7 天网格 + 上午/下午分区 + 甘特图 |
| 月视图 | 月历网格，显示每日任务 |
| 年视图 | 热力图，显示任务密度 |

**视图切换**：顶部按钮组

**导航**：
- 上一周/月/年
- 下一周/月/年
- 回到今天

#### 3.2.2 周视图功能

**布局结构**：
```
┌─────────────────────────────────────────────────┐
│ 甘特图区域（跨天任务）                           │
├─────────────────────────────────────────────────┤
│ 持续任务标签 │ 周一 │ 周二 │ 周三 │ ... │ 周日  │
├──────────────┼──────┼──────┼──────┼─────┼───────┤
│    上午      │      │      │      │     │       │
├──────────────┼──────┼──────┼──────┼─────┼───────┤
│    下午      │      │      │      │     │       │
└─────────────────────────────────────────────────┘
```

**甘特图**：
- 显示跨天任务（start_date ≠ due_date）
- 任务条跨越多列
- 显示持续天数标签
- 左侧显示优先级色条

**单元格操作**：
- 拖放任务调整日期
- 右键菜单操作

#### 3.2.3 右键菜单

**单元格右键**：
- 新建任务（预填日期）
- 复制本周/本月已完成任务（显示已完成数量）
- 复制格式设置

**任务右键**：
- 编辑任务
- 标记完成/取消完成
- 删除任务

#### 3.2.4 拖放交互

**周视图拖放**：
- 拖放到上午区：设置 due_date，提醒时间设为 09:00
- 拖放到下午区：设置 due_date，提醒时间设为 14:00

**月视图拖放**：
- 拖放到日期格子，更新 due_date

### 3.3 周期任务

#### 3.3.1 周期模板属性

| 属性 | 类型 | 说明 |
|------|------|------|
| 标题 | 文本 | 任务名称 |
| 频率 | 枚举 | daily/weekly/monthly/workday/holiday/custom |
| 生成时间 | 时:分 | 每日生成的时间点 |
| 提醒时间 | 时:分 | 生成任务的提醒时间 |
| 优先级 | 枚举 | 五级优先级 |
| 启用状态 | 布尔 | 是否启用 |
| 上次生成日期 | 日期 | 防止重复生成 |

#### 3.3.2 频率类型

| 类型 | 配置 | 说明 |
|------|------|------|
| 每日 (daily) | 无 | 每天生成 |
| 每周 (weekly) | weekDays[] | 指定星期几（1-7） |
| 每月 (monthly) | monthDays[] | 指定日期（1-31） |
| 工作日 (workday) | 无 | 周一至周五 |
| 休息日 (holiday) | 无 | 周六、周日 |
| 自定义 (custom) | startDate, intervalDays, remindDayOffsets[] | N 天周期 + 提醒偏移 |

#### 3.3.3 管理界面

**列表功能**：
- 显示所有周期模板
- 启用/禁用切换（开关按钮）
- 删除模板（带确认）

**编辑表单**：
- 标题
- 频率类型选择（图标卡片）
- 频率配置（根据类型动态显示）
- 生成时间
- 提醒时间（可选）
- 优先级

### 3.4 智能闪念胶囊

#### 3.4.1 功能概述

快速输入自然语言，自动解析为结构化任务。

#### 3.4.2 解析引擎

**本地解析器**：
- 使用 chrono-node 解析时间表达式
- 支持中英文日期/时间
- 支持相对时间（明天、下周一等）

**AI 解析器**：
- 支持 Gemini API
- 支持 OpenAI 兼容 API
- 可配置多个 Provider
- 动态系统提示词（注入当前时间）

#### 3.4.3 AI Provider 配置

| 属性 | 说明 |
|------|------|
| 类型 | gemini / openai_compatible |
| 名称 | 显示名称 |
| Base URL | API 地址 |
| API Key | 密钥（加密存储） |
| 模型名称 | 如 gemini-2.5-flash-latest |
| 系统提示词 | 可自定义 |
| Temperature | 温度参数（0-1） |
| Max Tokens | 最大令牌数 |
| 默认选项 | 是否为默认 Provider |

### 3.5 笔记系统

#### 3.5.1 笔记属性

| 属性 | 说明 |
|------|------|
| 标题 | 笔记名称 |
| 内容 | Markdown 格式 |
| 置顶 | 是否置顶 |
| 浮动 | 是否在浮动窗口中打开 |
| 创建时间 | 时间戳 |
| 更新时间 | 时间戳 |

#### 3.5.2 笔记列表

**布局**：左右分栏（列表 + 编辑器）

**列表功能**：
- 搜索过滤
- 置顶优先排序
- 置顶切换
- 删除笔记
- 双击重命名

**状态指示**：
- 黄点：置顶
- 蓝点：浮动中
- 灰点：普通

#### 3.5.3 编辑器

**视图模式**：
- 编辑：纯文本编辑
- 双栏：左编辑右预览
- 拆分：按行拆分（点击复制）
- 预览：纯 Markdown 渲染

**工具栏**：
- 粗体/斜体/链接
- 标题级别
- 列表
- 代码块
- 图片插入

**快捷键**：
- `Ctrl+B`: 粗体
- `Ctrl+I`: 斜体
- `Ctrl+K`: 链接
- `Tab`: 缩进

**自动保存**：
- 1 秒防抖
- 状态显示：已保存/保存中/未保存

**图片支持**：
- 拖放图片自动保存并插入 Markdown
- 图片保存到专用目录

#### 3.5.4 浮动窗口

- 独立窗口显示笔记
- 支持同步编辑
- 支持置顶

#### 3.5.5 主页笔记卡片

**功能概述**：
将笔记作为卡片固定显示在主页任务仪表盘，与任务卡片并列展示，支持直接编辑。

**入口方式**：
- 笔记列表页：点击笔记旁的"添加到主页"按钮
- 主页添加面板：选择"笔记卡片" → 从列表选择或新建笔记

**笔记卡片属性**：

| 属性 | 类型 | 说明 |
|------|------|------|
| showOnDashboard | 布尔 | 是否在主页显示 |
| dashboardOrder | 数字 | 在主页的排序位置 |

**笔记卡片功能**：
- 直接在主页编辑笔记内容（Markdown）
- 编辑/预览模式切换
- 自动保存（1秒防抖）
- 支持开启浮动窗口
- 从主页移除（不删除笔记）
- 支持拖拽排序（与任务卡片混排）

**交互规则**：
- 笔记卡片与任务卡片共享最多 6 个卡片位
- 拖拽时使用全局索引排序，支持任务卡片与笔记卡片交叉排序
- 新建笔记时可同步创建并直接添加到主页

### 3.6 桌面挂件

#### 3.6.1 任务卡片浮动窗口

**功能**：
- 独立显示某个面板的任务
- 支持置顶 (Always on Top)
- 支持嵌入桌面
- 支持边缘隐藏

**入口**：面板标题栏的浮动按钮

#### 3.6.2 周视图挂件

**功能**：
- 显示周视图
- 边缘自动隐藏
- 悬停边缘展开
- 拖拽定位

#### 3.6.3 桌面嵌入

**Windows 专属功能**：
- 使用 koffi 调用 Win32 API
- 嵌入到桌面层（低于其他窗口）
- 支持高 DPI 缩放

### 3.7 系统设置

#### 3.7.1 外观设置

**主题模式**：
- 渐变模式：多色渐变背景
- 纯色模式：单色背景
- 壁纸模式：自定义壁纸

**渐变配置**：
- 颜色选择（最多 4 色）
- 渐变方向
- 预设配色保存

**透明度调节**：
- 背景透明度
- 面板透明度
- 弹窗透明度

**深色模式**：支持

#### 3.7.2 快捷键设置

**可配置快捷键**：
- 唤起闪念胶囊
- 显示/隐藏主窗口
- 其他自定义快捷键

**快捷键录制**：
- 点击录制按钮
- 按下组合键
- 自动保存

#### 3.7.3 AI 设置

**Provider 管理**：
- 添加/编辑/删除 Provider
- 设置默认 Provider
- 启用/禁用

**参数配置**：
- Temperature（创造性）
- Max Tokens（响应长度）
- 系统提示词

#### 3.7.4 数据设置

**笔记存储路径**：
- 自定义笔记文件存储位置

**开机自启**：
- 开关控制

**语言设置**：
- 中文 / 英文

### 3.8 数据管理

#### 3.8.1 Excel 导入

**支持字段**：

| Excel 列 | 任务字段 |
|----------|----------|
| 任务标题 | title |
| 任务描述 | description |
| 优先级 | priority |
| 开始日期 | start_date |
| 截止日期 | due_date |
| 目标卡片 | panel_id |
| 提醒开关 | reminder_enabled |
| 提醒日期 | reminder_date |
| 提醒时间 | reminder_hour/minute |

**导入流程**：
1. 选择文件或拖放
2. 预览解析结果
3. 选择目标面板
4. 确认导入

**模板下载**：
- 提供标准模板文件
- 包含示例数据和格式说明

#### 3.8.2 数据备份

**自动备份**：
- 定期自动备份数据库

**手动备份**：
- 导出数据库文件
- 选择保存位置

#### 3.8.3 数据还原

**还原流程**：
1. 选择备份文件
2. 确认覆盖
3. 重启应用

---

## 4. 业务规则

### 4.1 任务过滤规则

#### 4.1.1 今日待办面板过滤

任务满足以下条件之一即显示在"今日待办"面板：

1. **未完成的普通任务**（满足全部条件）：
   - `panel_id` 为空（不属于自定义面板）
   - `status` 为 `todo`
   - `due_date <= 今日日期`（截止日期已到或逾期）

2. **今日完成的任务**：
   - `completed_at` 以今日日期开头（如 `2025-12-28T...`）

```javascript
// 过滤逻辑伪代码
function filterTodayTask(task) {
  if (task.panel_id !== null) return false  // 排除自定义面板任务
  
  if (task.status !== 'done') {
    // 未完成任务：截止日期 <= 今天
    return task.due_date !== null && task.due_date <= today
  }
  
  // 已完成任务：只显示今天完成的
  return task.completed_at?.startsWith(today) ?? false
}
```

#### 4.1.2 自定义面板过滤

- 任务 `panel_id` 等于面板 ID 时显示在该面板

#### 4.1.3 日历视图任务过滤

- **普通任务**：`start_date === due_date`，按日期显示在对应格子
- **跨天任务**：`start_date !== due_date`，在甘特图区域显示

### 4.2 任务排序规则

任务列表按以下优先级排序：

```javascript
function sortTasks(tasks) {
  return tasks.sort((a, b) => {
    // 1. 未完成优先于已完成
    if (a.status !== b.status) {
      return a.status === 'done' ? 1 : -1
    }
    // 2. 置顶优先
    if (a.is_pinned !== b.is_pinned) {
      return a.is_pinned ? -1 : 1
    }
    // 3. 按 rank 字符串排序
    return a.rank.localeCompare(b.rank)
  })
}
```

#### 4.2.1 Rank 生成规则

- 新任务创建时 `rank` 默认为创建时间的 ISO 字符串
- 拖放排序时生成新 rank：
  - **向下拖动**：`目标rank + '~' + timestamp`（`~` 字符大于字母）
  - **向上拖动**：`目标rank[:-1] + '!' + timestamp`（`!` 字符小于字母）
- 置顶时：在置顶组最大 rank 后追加 `~timestamp`
- 取消置顶时：在普通组最小 rank 前追加 `!timestamp`

### 4.3 任务拖放规则

#### 4.3.1 面板间拖放

| 源面板 | 目标面板 | 行为 |
|--------|----------|------|
| 今日待办 | 自定义面板 | 设置 `panel_id`，清除 `due_date` |
| 自定义面板 | 今日待办 | 清除 `panel_id`，设置 `due_date` 为今日 |
| 任意面板 | 置顶区 | 设置 `is_pinned = true` |
| 置顶区 | 普通区 | 设置 `is_pinned = false` |

#### 4.3.2 日历拖放

| 目标区域 | 行为 |
|----------|------|
| 上午区 (AM) | 设置 `due_date`，如有提醒则设为 09:00 |
| 下午区 (PM) | 设置 `due_date`，如有提醒则设为 14:00 |
| 日期格子 | 仅设置 `due_date` 保持时间 |

#### 4.3.3 拖放冲突处理

- 拖放任务时自动取消置顶状态（除非拖到置顶区）
- 保留任务的其他属性不变

### 4.4 周期任务调度规则

#### 4.4.1 调度时机

- 应用启动时检查
- 每 60 秒定时检查
- 手动触发检查

#### 4.4.2 生成条件

1. 模板 `enabled = true`
2. 今日日期满足频率规则
3. `last_generated !== 今日日期`（今日未生成）
4. 如设置时间，当前时间 >= 设定时间

#### 4.4.3 频率类型判断

| 类型 | 规则 |
|------|------|
| `daily` | 每天生成 |
| `weekly` | `weekDays` 包含当日星期几（1-7） |
| `monthly` | `monthDays` 包含当日日期（1-31） |
| `workday` | 周一至周五（dayOfWeek 1-5） |
| `holiday` | 周六或周日（dayOfWeek 6-7） |
| `custom` | `(今日 - startDate) % intervalDays + 1` 在 `remindDayOffsets` 中 |

### 4.5 持续任务生成规则

#### 4.5.1 持续任务定义

- 任务 `auto_generate_daily = true`
- 任务 `status !== 'done'`
- 今日在任务日期范围内：`start_date <= 今日 <= due_date`

#### 4.5.2 每日实例生成

1. 检查是否已存在今日实例：`parent_id = 父任务ID AND due_date = 今日 AND description LIKE '%[Daily Instance]%'`
2. 如不存在，创建新实例：
   - 标题：`{父任务标题} (今日)`
   - 描述追加：`[Daily Instance] Auto-generated from continuous task.`
   - `parent_id` 指向父任务
   - `start_date` 和 `due_date` 均为今日

### 4.6 提醒系统规则

#### 4.6.1 提醒检查

- 检查间隔：60 秒
- 检查对象：主任务 + 子任务

#### 4.6.2 发送条件

任务/子任务满足全部条件时发送提醒：

1. `status !== 'done'`（未完成）
2. `reminder_sent !== true`（未发送过）
3. `reminder_enabled = true`
4. `reminder_date`、`reminder_hour`、`reminder_minute` 均已设置
5. 提醒时间 <= 当前时间

#### 4.6.3 提醒发送后

- 设置 `reminder_sent = 1` 持久化到数据库
- 避免应用重启后重复提醒

#### 4.6.4 子任务提醒

- 额外检查：父任务 `status !== 'done'`
- 通知标题：`子任务: {子任务标题}`

### 4.7 日历视图规则

#### 4.7.1 上午/下午判断

任务基于以下规则判定为上午 (AM) 或下午 (PM)：

```javascript
function isTaskAM(task) {
  // 1. 优先使用 reminder_time
  if (task.reminder_time) {
    const [hours] = task.reminder_time.split(':').map(Number)
    return hours < 12
  }
  // 2. 使用 reminder_hour
  if (task.reminder_hour != null) {
    return task.reminder_hour < 12
  }
  // 3. 使用创建时间
  if (task.created_at) {
    const hour = new Date(task.created_at).getHours()
    return hour < 12
  }
  // 4. 默认为上午
  return true
}
```

#### 4.7.2 跨天任务甘特图

- 显示条件：`start_date !== due_date`
- 可见范围计算：任务日期与当前周交集
- 列索引：0 (周一) - 6 (周日)

### 4.8 面板管理规则

#### 4.8.1 面板限制

- 最大自定义面板数：**6 个**
- 默认面板尺寸：360 x 300 px

#### 4.8.2 面板删除

删除面板时级联操作：
1. 删除属于该面板的任务的子任务
2. 删除属于该面板的任务
3. 删除面板本身

#### 4.8.3 首次安装默认面板

```javascript
const defaultPanels = [
  { id: 'panel-work', title: '🏢 工作', sort_order: 0 },
  { id: 'panel-study', title: '📚 学习', sort_order: 1 },
  { id: 'panel-life', title: '🏠 生活', sort_order: 2 }
]
```

---

## 5. 非功能需求

### 5.1 性能需求

- 应用启动时间 < 3 秒
- 任务列表渲染 < 100ms
- 数据库查询响应 < 50ms

### 5.2 安全需求

- API Key 加密存储
- 本地数据不上传
- 无网络依赖

### 5.3 兼容性需求

- Windows 10/11 64位
- 屏幕分辨率 1366x768 及以上
- 支持高 DPI 显示

---

## 6. 术语表

| 术语 | 说明 |
|------|------|
| Task | 任务，包含标题、描述、状态、优先级等属性 |
| Subtask | 子任务，隶属于某个主任务 |
| Panel | 面板，用于分类展示任务的容器 |
| Recurring Template | 周期任务模板，定义重复规则 |
| Continuous Task | 持续任务，每日自动生成实例的跨天任务 |
| Capsule | 闪念胶囊，快速输入并解析任务 |
| Glassmorphism | 毛玻璃拟态，一种设计风格 |
| DnD | Drag and Drop，拖放功能 |
| Rank | 排序权重字符串，用于任务列表排序 |
| AM/PM | 上午/下午，日历视图的时段划分 |
